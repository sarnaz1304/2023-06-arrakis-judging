cergyk

high

# Lack of price deviation check on deposit allows any user to drain vault

## Summary
A vault depositor can use the `ArrakisRouter` to deposit on a vault while underlying Univ3 pools are imbalanced, which can allow them to backrun the deposit by rebalancing the pools and getting their funds back (provided the vault is handling multiple `feeTiers` at that moment). 

## Vulnerability Detail
On a public trustless vault setup, a depositor has to deposit to a arrakis vault through the arrakis router.
As we see in the `rebalance` function of `SimpleManager` some protections have to be implemented, to prevent a minter to add liquidity to an imbalanced pool, which can lead to loss of funds for the vault:
https://github.com/sherlock-audit/2023-06-arrakis/blob/main/v2-manager-templates/contracts/SimpleManager.sol#L366-L385

In comparison, no such protection are implemented in the path used by a public depositor. 
Neither in `ArrakisV2Router` nor in `ArrakisV2` the price deviation from a chainlink oracle is checked when adding liquidity.

So Alice as a depositor can do the following steps:

- Take a flash loan to make a large swap in the UNIv3 pools where the Arrakis vault WETH/USDC has provided liquidity (please note that except for the fees paid during this imbalancing, the `totalUnderlying` of the vault is unchanged by this operation, so Alice receives the same share of the vault which would be proportional to amount0/amount1 provided).

- Self backrun the `addLiquidity` operation by rebalancing the UNIv3 WETH/USDC pool, getting back most of the funds provided during addLiquidity, but keeping the Arrakis vault shares.

Later when redeeming the vault shares, Alice would receive more than deserved, and would be effectively stealing from other vault depositors.

NB: Also note that a sandwich bot could do this to any other deposit, but would be stealing from the vault not the user (the user would still get the same shares). So the attack described here (triggering and self-backrunning) is stronger than simple sandwich, as it enables to drain the vault completely.

## Impact
A vault depositor can inflate his own shares through pool manipulation, and steal from other users by self-backrunning, eventually draining the vault completely.

## Code Snippet

## Tool used

Manual Review

## Recommendation
Add the same price deviation protection as in `SimpleManager.rebalance` in `ArrakisV2Router` when adding liquidity.